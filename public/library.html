<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Library — Ferro Animus</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #c9a84c;
      --gold-light: #e8c878;
      --gold-dim: #5a3e14;
      --gold-mid: #8a6828;
      --bg-deep: #060504;
      --bg-dark: #0c0a08;
      --bg-panel: #111009;
      --bg-panel2: #16130e;
      --border: #2e2720;
      --red: #b03020;
      --red-glow: #ff5544;
      --amber: #d4823a;
      --green: #1e8c50;
      --green-glow: #3dff8a;
      --text-dim: #5a5040;
      --text-mid: #9a8e78;
      --text: #ddd8cc;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg-deep);
      color: var(--text);
      font-family: 'Cinzel', serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

    /* ── TOP NAV ── */
    #topbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      height: 52px;
      background: linear-gradient(180deg, rgba(6,5,4,0.98) 0%, rgba(6,5,4,0.92) 100%);
      border-bottom: 1px solid var(--gold-dim);
      display: flex; align-items: center; padding: 0 20px; gap: 0;
    }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    #topbar a {
      display: flex; align-items: center; gap: 7px;
      color: var(--gold); text-decoration: none;
      font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 0.1em;
      opacity: 0.8; transition: opacity 0.2s; white-space: nowrap;
    }
    #topbar a:hover { opacity: 1; }
    .topbar-divider { width: 1px; height: 20px; background: var(--gold-dim); opacity: 0.5; }
    .topbar-spacer { flex: 1; }
    .btn-logout {
      background: transparent; border: 1px solid var(--gold-dim);
      color: var(--text-mid); font-family: 'Cinzel', serif;
      font-size: 9px; letter-spacing: 2px; padding: 5px 12px;
      cursor: pointer; transition: all 0.2s; margin-left: 12px;
    }
    .btn-logout:hover { border-color: var(--gold); color: var(--gold); }
    #level-badge {
      font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 0.12em;
      color: var(--gold); border: 1px solid var(--gold-dim); padding: 4px 14px;
    }

    /* ── HERO ── */
    #hero {
      position: relative;
      height: 100vh;
      background-image: url('/library-bg.png');
      background-size: cover;
      background-position: center top;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #hero::before {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(to bottom,
        rgba(6,5,4,0.45) 0%,
        rgba(6,5,4,0.55) 50%,
        rgba(6,5,4,1) 100%
      );
      z-index: 1;
    }
    .hero-content {
      position: relative; z-index: 2;
      display: flex; flex-direction: column;
      align-items: center; text-align: center;
      padding: 0 24px;
    }
    .hero-eyebrow {
      font-family: 'Cinzel', serif;
      font-size: 10px; letter-spacing: 8px;
      color: var(--gold-dim); text-transform: uppercase;
      margin-bottom: 20px;
    }
    .hero-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: clamp(32px, 7vw, 64px);
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.06em;
      text-shadow:
        0 0 30px rgba(201,168,76,0.9),
        0 0 70px rgba(201,168,76,0.5),
        0 0 140px rgba(201,168,76,0.2);
      line-height: 1.1;
      margin-bottom: 16px;
    }
    .hero-rule {
      display: flex; align-items: center; gap: 14px;
      justify-content: center; margin-bottom: 22px;
      width: 100%; max-width: 400px;
    }
    .hero-rule .line { height: 1px; flex: 1; background: linear-gradient(90deg, transparent, var(--gold-dim), transparent); }
    .hero-rule .diamond { width: 6px; height: 6px; background: var(--gold); transform: rotate(45deg); flex-shrink: 0; box-shadow: 0 0 6px rgba(201,168,76,0.6); }
    .hero-sub {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 17px;
      color: var(--text-mid);
      max-width: 500px;
      line-height: 1.6;
    }
    .scroll-hint {
      position: absolute; bottom: 36px; left: 50%; transform: translateX(-50%);
      z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 6px;
      color: var(--text-dim); font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
    }
    .scroll-hint .arrow {
      width: 18px; height: 18px;
      border-right: 1px solid var(--gold-dim); border-bottom: 1px solid var(--gold-dim);
      transform: rotate(45deg);
      animation: bounce 1.8s ease-in-out infinite;
    }
    @keyframes bounce {
      0%,100%{ transform: rotate(45deg) translateY(0); opacity: 0.5; }
      50%    { transform: rotate(45deg) translateY(6px); opacity: 1; }
    }

    /* ── CONTENT ── */
    #content {
      background: var(--bg-deep);
      position: relative; z-index: 1;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 64px 24px 100px;
    }
    .section-label {
      font-family: 'Cinzel', serif;
      font-size: 9px; letter-spacing: 4px;
      color: var(--gold-mid); text-transform: uppercase;
      margin-bottom: 24px;
    }
    .section-divider {
      display: flex; align-items: center; gap: 14px;
      margin: 52px 0;
    }
    .section-divider .line { height: 1px; flex: 1; background: linear-gradient(90deg, transparent, var(--gold-dim), transparent); }
    .section-divider .diamond { width: 7px; height: 7px; background: var(--gold-dim); transform: rotate(45deg); flex-shrink: 0; }

    /* ── CURRENTLY READING ── */
    #reading-section { position: relative; }

    /* Empty state — book input */
    #add-book-form {
      background: var(--bg-panel2);
      border: 1px solid var(--border);
      padding: 40px 36px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      text-align: center;
    }

    .empty-icon {
      width: 52px; height: 52px;
      border: 1px solid var(--gold-dim);
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-dim);
      margin-bottom: 4px;
    }
    .empty-label {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 16px;
      color: var(--text-dim);
    }

    .book-input-wrap {
      width: 100%; max-width: 480px;
      display: flex; gap: 10px;
    }
    #book-title-input {
      flex: 1;
      background: rgba(6,5,4,0.8);
      border: 1px solid var(--gold-dim);
      color: var(--text);
      font-family: 'Cinzel', serif;
      font-size: 12px; letter-spacing: 0.06em;
      padding: 12px 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    #book-title-input::placeholder { color: var(--text-dim); }
    #book-title-input:focus { border-color: var(--gold); }

    .btn-primary {
      background: transparent;
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-size: 10px; letter-spacing: 3px;
      padding: 12px 22px;
      cursor: pointer;
      text-transform: uppercase;
      white-space: nowrap;
      transition: background 0.2s, border-color 0.2s;
    }
    .btn-primary:hover {
      background: rgba(201,168,76,0.1);
      border-color: var(--gold);
    }

    /* Active book card */
    #current-book-card {
      background: var(--bg-panel2);
      border: 1px solid var(--gold-dim);
      position: relative;
      overflow: hidden;
    }
    #current-book-card::before {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(201,168,76,0.05) 0%, transparent 60%);
      pointer-events: none;
    }
    .book-card-top {
      padding: 32px 36px 28px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .book-card-reading-label {
      font-family: 'Cinzel', serif;
      font-size: 8px; letter-spacing: 5px;
      color: var(--gold-mid); text-transform: uppercase;
      margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .book-card-reading-label::before {
      content: '';
      width: 6px; height: 6px;
      background: var(--amber);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(212,130,58,0.8);
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100%{opacity:1;box-shadow:0 0 8px rgba(212,130,58,0.8)} 50%{opacity:0.5;box-shadow:0 0 3px rgba(212,130,58,0.3)} }
    .book-card-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: clamp(20px, 4vw, 32px);
      color: var(--gold-light);
      letter-spacing: 0.04em;
      line-height: 1.2;
      margin-bottom: 12px;
      text-shadow: 0 0 20px rgba(232,200,120,0.2);
    }
    .book-card-started {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 14px;
      color: var(--text-dim);
    }
    .book-card-actions {
      padding: 20px 36px;
      display: flex; align-items: center; gap: 16px;
    }
    .btn-finish {
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green-glow);
      font-family: 'Cinzel', serif;
      font-size: 10px; letter-spacing: 3px;
      padding: 11px 24px;
      cursor: pointer;
      text-transform: uppercase;
      transition: background 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-finish:hover { background: rgba(30,140,80,0.12); }
    .btn-replace {
      background: none; border: none;
      color: var(--text-dim);
      font-family: 'Cinzel', serif;
      font-size: 9px; letter-spacing: 2px;
      cursor: pointer;
      text-transform: uppercase;
      text-decoration: underline;
      text-decoration-color: var(--border);
      padding: 0;
      transition: color 0.2s;
    }
    .btn-replace:hover { color: var(--text-mid); }

    /* ── BOOK LOG ── */
    #log-section { }

    .log-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px;
    }
    .log-count {
      font-family: 'Cinzel Decorative', serif;
      font-size: 28px;
      color: var(--amber);
      text-shadow: 0 0 16px rgba(212,130,58,0.4);
    }
    .log-count-label {
      font-family: 'Cinzel', serif;
      font-size: 8px; letter-spacing: 3px;
      color: var(--text-dim); text-transform: uppercase;
      margin-top: 2px;
    }

    #book-log {
      background: var(--bg-panel);
      border: 1px solid var(--border);
    }

    .log-empty {
      padding: 36px 24px;
      text-align: center;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 15px;
      color: var(--text-dim);
    }

    .log-entry {
      display: flex; align-items: center; gap: 20px;
      padding: 18px 24px;
      border-bottom: 1px solid rgba(46,39,32,0.5);
      transition: background 0.2s;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-entry:hover { background: rgba(201,168,76,0.03); }

    .log-num {
      font-family: 'Cinzel Decorative', serif;
      font-size: 13px;
      color: var(--gold-dim);
      min-width: 28px;
      text-align: center;
      flex-shrink: 0;
    }

    .log-title {
      font-family: 'Cinzel', serif;
      font-size: 13px; letter-spacing: 0.06em;
      color: var(--text);
      flex: 1;
      line-height: 1.4;
    }

    .log-date {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 13px;
      color: var(--text-dim);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .log-check {
      color: var(--green-glow);
      flex-shrink: 0;
      opacity: 0.7;
    }

    /* ── WANT TO READ ── */
    .wishlist-input-row {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    #wishlist-input {
      flex: 1;
      background: rgba(6,5,4,0.8);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Cinzel', serif;
      font-size: 12px; letter-spacing: 0.06em;
      padding: 11px 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    #wishlist-input::placeholder { color: var(--text-dim); }
    #wishlist-input:focus { border-color: var(--gold-dim); }

    #wishlist-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--bg-panel);
      border: 1px solid var(--border);
    }
    .wishlist-empty {
      padding: 28px 24px;
      text-align: center;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 15px;
      color: var(--text-dim);
    }
    .wishlist-entry {
      display: flex; align-items: center; gap: 16px;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(46,39,32,0.5);
      transition: background 0.2s;
    }
    .wishlist-entry:last-child { border-bottom: none; }
    .wishlist-entry:hover { background: rgba(201,168,76,0.03); }
    .wishlist-entry-title {
      font-family: 'Cinzel', serif;
      font-size: 12px; letter-spacing: 0.06em;
      color: var(--text-mid);
      flex: 1;
    }
    .btn-start-reading {
      background: none;
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-size: 8px; letter-spacing: 2px;
      padding: 5px 12px;
      cursor: pointer;
      text-transform: uppercase;
      white-space: nowrap;
      transition: background 0.2s, border-color 0.2s;
      flex-shrink: 0;
    }
    .btn-start-reading:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }
    .btn-remove-wish {
      background: none; border: none;
      color: var(--text-dim);
      font-size: 16px; line-height: 1;
      cursor: pointer;
      padding: 2px 4px;
      transition: color 0.2s;
      flex-shrink: 0;
    }
    .btn-remove-wish:hover { color: var(--red-glow); }

    /* ── XP TOAST ── */
    #xp-toast {
      position: fixed;
      bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: rgba(6,5,4,0.95);
      border: 1px solid var(--gold-dim);
      padding: 14px 28px;
      display: flex; align-items: center; gap: 14px;
      font-family: 'Cinzel', serif;
      font-size: 11px; letter-spacing: 3px;
      color: var(--gold);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 999;
      text-transform: uppercase;
      white-space: nowrap;
    }
    #xp-toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    #xp-toast .toast-xp {
      font-family: 'Cinzel Decorative', serif;
      font-size: 18px;
      color: var(--gold-light);
      text-shadow: 0 0 12px rgba(232,200,120,0.6);
    }
    #xp-toast .toast-wis {
      font-size: 10px;
      color: var(--text-mid);
      letter-spacing: 2px;
    }

    /* ── REPLACE INPUT (hidden by default) ── */
    #replace-form {
      display: none;
      padding: 16px 36px;
      border-top: 1px solid var(--border);
      gap: 10px;
      background: rgba(6,5,4,0.5);
    }
    #replace-form.visible {
      display: flex;
    }
    #replace-input {
      flex: 1;
      background: rgba(6,5,4,0.8);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Cinzel', serif;
      font-size: 12px; letter-spacing: 0.06em;
      padding: 10px 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    #replace-input::placeholder { color: var(--text-dim); }
    #replace-input:focus { border-color: var(--gold-dim); }
    .btn-replace-confirm {
      background: transparent;
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-size: 9px; letter-spacing: 2px;
      padding: 10px 18px;
      cursor: pointer;
      text-transform: uppercase;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .btn-replace-confirm:hover { background: rgba(201,168,76,0.08); }
    .btn-cancel {
      background: none; border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: 'Cinzel', serif;
      font-size: 9px; letter-spacing: 2px;
      padding: 10px 14px;
      cursor: pointer;
      text-transform: uppercase;
    }
    .btn-cancel:hover { border-color: var(--text-dim); }
  </style>
</head>
<body>

<!-- ── Top Nav ── -->
<div id="topbar">
  <div class="topbar-left">
    <a href="/map">
      <svg width="15" height="15" viewBox="0 0 16 16" fill="none">
        <path d="M10 3L5 8L10 13" stroke="#c9a84c" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      World Map
    </a>
    <div class="topbar-divider"></div>
    <a href="/">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="none">
        <path d="M2 6.5L8 2L14 6.5V14H10V10H6V14H2V6.5Z" stroke="#c9a84c" stroke-width="1.3" stroke-linejoin="round"/>
      </svg>
      Dashboard
    </a>
    <div class="topbar-divider"></div>
    <a href="/story">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="none">
        <path d="M3 2h8l2 2v11H3V2z" stroke="#c9a84c" stroke-width="1.3" stroke-linejoin="round"/>
        <path d="M6 6h5M6 9h5M6 12h3" stroke="#c9a84c" stroke-width="1.1" stroke-linecap="round"/>
      </svg>
      Chronicle
    </a>
  </div>
  <div class="topbar-spacer"></div>
  <div id="level-badge">LVL —</div>
  <button class="btn-logout" onclick="logout()">↩ LOGOUT</button>
</div>

<!-- ── Hero ── -->
<section id="hero">
  <div class="hero-content">
    <div class="hero-eyebrow">The Arcane Collection</div>
    <h1 class="hero-title">The Library</h1>
    <div class="hero-rule">
      <div class="line"></div><div class="diamond"></div><div class="line"></div>
    </div>
    <p class="hero-sub">Every tome studied is a weapon forged. Every page turned is a wall rebuilt.</p>
  </div>
  <div class="scroll-hint">
    <div class="arrow"></div>
  </div>
</section>

<!-- ── Content ── -->
<div id="content">
  <div class="container">

    <!-- Currently Reading -->
    <div id="reading-section">
      <div class="section-label">Currently Reading</div>

      <!-- Empty state -->
      <div id="add-book-form">
        <div class="empty-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M4 19V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v13" stroke="#5a3e14" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M4 19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2" stroke="#5a3e14" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M9 8h6M9 12h6" stroke="#5a3e14" stroke-width="1.3" stroke-linecap="round"/>
          </svg>
        </div>
        <p class="empty-label">The reading stand awaits a new tome.</p>
        <div class="book-input-wrap">
          <input id="book-title-input" type="text" placeholder="Enter book title..." maxlength="200" autocomplete="off"/>
          <button class="btn-primary" onclick="beginReading()">Open the Tome</button>
        </div>
      </div>

      <!-- Active book card -->
      <div id="current-book-card" style="display:none;">
        <div class="book-card-top">
          <div class="book-card-reading-label">Now Reading</div>
          <div class="book-card-title" id="card-title">—</div>
          <div class="book-card-started" id="card-started">—</div>
        </div>
        <div class="book-card-actions">
          <button class="btn-finish" id="btn-finish" onclick="markFinished()">
            <svg width="13" height="13" viewBox="0 0 16 16" fill="none">
              <path d="M3 8l4 4 6-6" stroke="#3dff8a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Mark as Finished
          </button>
          <button class="btn-replace" onclick="toggleReplace()">Begin another tome</button>
        </div>
        <div id="replace-form">
          <input id="replace-input" type="text" placeholder="New book title..." maxlength="200" autocomplete="off"/>
          <button class="btn-replace-confirm" onclick="replaceBook()">Open</button>
          <button class="btn-cancel" onclick="toggleReplace()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Section divider -->
    <div class="section-divider">
      <div class="line"></div><div class="diamond"></div><div class="line"></div>
    </div>

    <!-- Book Log -->
    <div id="log-section">
      <div class="log-header">
        <div class="section-label" style="margin-bottom:0;">Completed Tomes</div>
        <div style="text-align:right;">
          <div class="log-count" id="log-count">0</div>
          <div class="log-count-label">Tomes Read</div>
        </div>
      </div>

      <div id="book-log">
        <div class="log-empty" id="log-empty">No tomes completed yet. The shelves await your victories.</div>
      </div>
    </div>

    <!-- Section divider -->
    <div class="section-divider">
      <div class="line"></div><div class="diamond"></div><div class="line"></div>
    </div>

    <!-- Want to Read -->
    <div id="wishlist-section">
      <div class="section-label">Want to Read</div>
      <div class="wishlist-input-row">
        <input id="wishlist-input" type="text" placeholder="Add a title to your list..." maxlength="200" autocomplete="off"/>
        <button class="btn-primary" onclick="addToWishlist()">Add</button>
      </div>
      <div id="wishlist-list">
        <div class="wishlist-empty">Your reading queue is empty.</div>
      </div>
    </div>

  </div>
</div>

<!-- XP Toast -->
<div id="xp-toast">
  <span class="toast-xp">+200 XP</span>
  <span>Tome completed</span>
  <span class="toast-wis">+WIS</span>
</div>

<script>
'use strict';

function logout() {
  fetch('/api/logout', { method: 'POST' }).then(() => { window.location.href = '/login'; });
}

let currentBookId = null;

/* ── Render ── */
function render(data) {
  const { current, log, wishlist = [] } = data;

  // Currently reading
  if (current) {
    currentBookId = current.id;
    document.getElementById('add-book-form').style.display    = 'none';
    document.getElementById('current-book-card').style.display = 'block';
    document.getElementById('card-title').textContent   = current.title;
    document.getElementById('card-started').textContent = `Opened ${current.started_at}`;
  } else {
    currentBookId = null;
    document.getElementById('add-book-form').style.display    = 'flex';
    document.getElementById('current-book-card').style.display = 'none';
    document.getElementById('book-title-input').value = '';
    document.getElementById('replace-form').classList.remove('visible');
  }

  // Log
  document.getElementById('log-count').textContent = log.length;
  const logEl = document.getElementById('book-log');

  if (!log.length) {
    logEl.innerHTML = '<div class="log-empty" id="log-empty">No tomes completed yet. The shelves await your victories.</div>';
  } else {
    logEl.innerHTML = log.map((b, i) => `
      <div class="log-entry">
        <div class="log-num">${toRoman(log.length - i)}</div>
        <div class="log-title">${escHtml(b.title)}</div>
        <div class="log-date">${b.completed_at || ''}</div>
        <div class="log-check">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
            <path d="M3 8l4 4 6-6" stroke="#3dff8a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>`).join('');
  }

  // Wishlist
  const wlEl = document.getElementById('wishlist-list');
  if (!wishlist.length) {
    wlEl.innerHTML = '<div class="wishlist-empty">Your reading queue is empty.</div>';
  } else {
    wlEl.innerHTML = wishlist.map(w => `
      <div class="wishlist-entry" id="wl-${w.id}">
        <div class="wishlist-entry-title">${escHtml(w.title)}</div>
        <button class="btn-start-reading" onclick="startFromWishlist(${w.id})">Start Reading</button>
        <button class="btn-remove-wish" onclick="removeFromWishlist(${w.id})" title="Remove">×</button>
      </div>`).join('');
  }
}

/* ── Actions ── */
async function beginReading() {
  const title = document.getElementById('book-title-input').value.trim();
  if (!title) return;
  const res  = await fetch('/api/books', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title }) });
  const data = await res.json();
  render(data);
}

async function markFinished() {
  if (!currentBookId) return;
  const res  = await fetch(`/api/books/${currentBookId}/finish`, { method: 'POST' });
  const data = await res.json();
  render(data);
  if (data.xpAwarded) showToast();
}

function showToast() {
  const toast = document.getElementById('xp-toast');
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 3200);
}

async function replaceBook() {
  const title = document.getElementById('replace-input').value.trim();
  if (!title) return;
  // Mark current as finished first (quietly), then start new
  if (currentBookId) {
    await fetch(`/api/books/${currentBookId}/finish`, { method: 'POST' });
  }
  const res  = await fetch('/api/books', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title }) });
  const data = await res.json();
  render(data);
}

function toggleReplace() {
  const form = document.getElementById('replace-form');
  form.classList.toggle('visible');
  if (form.classList.contains('visible')) {
    document.getElementById('replace-input').focus();
  }
}

async function addToWishlist() {
  const input = document.getElementById('wishlist-input');
  const title = input.value.trim();
  if (!title) return;
  input.value = '';
  await fetch('/api/reading-list', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title }) });
  render(await fetchAll());
}

async function removeFromWishlist(id) {
  await fetch(`/api/reading-list/${id}`, { method: 'DELETE' });
  render(await fetchAll());
}

async function startFromWishlist(id) {
  const res  = await fetch(`/api/reading-list/${id}/start`, { method: 'POST' });
  render(await res.json());
}

async function fetchAll() {
  const res = await fetch('/api/books');
  return res.json();
}

/* ── Enter to submit ── */
document.getElementById('book-title-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') beginReading();
});
document.getElementById('wishlist-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') addToWishlist();
});

/* ── Helpers ── */
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toRoman(n) {
  if (n > 20) return n; // fall back to numbers for large counts
  const vals = [20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1];
  const syms = ['XX','XIX','XVIII','XVII','XVI','XV','XIV','XIII','XII','XI','X','IX','VIII','VII','VI','V','IV','III','II','I'];
  for (let i = 0; i < vals.length; i++) if (n >= vals[i]) return syms[i];
  return n;
}

/* ── Init ── */
async function init() {
  try {
    const [mapRes, booksRes] = await Promise.all([fetch('/api/map'), fetch('/api/books')]);
    const mapData   = await mapRes.json();
    const booksData = await booksRes.json();
    document.getElementById('level-badge').textContent = `LVL ${mapData.level || 1}`;
    render(booksData);
  } catch (e) {
    console.warn('Init failed:', e);
    document.getElementById('level-badge').textContent = 'LVL 1';
    render({ current: null, log: [] });
  }
}

init();
</script>
<div style="position:fixed;bottom:10px;right:14px;font-family:serif;font-size:10px;letter-spacing:2px;color:rgba(180,160,100,0.5);pointer-events:none;z-index:9999;border:1px solid rgba(180,160,100,0.25);padding:4px 8px;">Created by Samuel B. Dunlap</div>
</body>
</html>
